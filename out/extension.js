/*

ç‰ˆæƒæ‰€æœ‰ï¼ˆcï¼‰2022 dsy4567ï¼ˆhttps://github.com/dsy4567/ ; dsy4567@outlook.comï¼‰

å996è®¸å¯è¯ç‰ˆæœ¬1.0

åœ¨ç¬¦åˆä¸‹åˆ—æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œç‰¹æ­¤å…è´¹å‘ä»»ä½•å¾—åˆ°æœ¬æˆæƒä½œå“çš„å‰¯æœ¬ï¼ˆåŒ…æ‹¬æºä»£ç ã€æ–‡ä»¶å’Œ/æˆ–ç›¸å…³å†…å®¹ï¼Œä»¥
ä¸‹ç»Ÿç§°ä¸ºâ€œæˆæƒä½œå“â€ï¼‰çš„ä¸ªäººå’Œæ³•äººå®ä½“æˆæƒï¼šè¢«æˆæƒä¸ªäººæˆ–æ³•äººå®ä½“æœ‰æƒä»¥ä»»ä½•ç›®çš„å¤„ç½®æˆæƒä½œå“ï¼ŒåŒ…æ‹¬
ä½†ä¸é™äºä½¿ç”¨ã€å¤åˆ¶ï¼Œä¿®æ”¹ï¼Œè¡ç”Ÿåˆ©ç”¨ã€æ•£å¸ƒï¼Œå‘å¸ƒå’Œå†è®¸å¯ï¼š

1. ä¸ªäººæˆ–æ³•äººå®ä½“å¿…é¡»åœ¨è®¸å¯ä½œå“çš„æ¯ä¸ªå†æ•£å¸ƒæˆ–è¡ç”Ÿå‰¯æœ¬ä¸ŠåŒ…å«ä»¥ä¸Šç‰ˆæƒå£°æ˜å’Œæœ¬è®¸å¯è¯ï¼Œä¸å¾—è‡ªè¡Œä¿®
æ”¹ã€‚
2. ä¸ªäººæˆ–æ³•äººå®ä½“å¿…é¡»ä¸¥æ ¼éµå®ˆä¸ä¸ªäººå®é™…æ‰€åœ¨åœ°æˆ–ä¸ªäººå‡ºç”Ÿåœ°æˆ–å½’åŒ–åœ°ã€æˆ–æ³•äººå®ä½“æ³¨å†Œåœ°æˆ–ç»è¥åœ°ï¼ˆ
ä»¥è¾ƒä¸¥æ ¼è€…ä¸ºå‡†ï¼‰çš„å¸æ³•ç®¡è¾–åŒºæ‰€æœ‰é€‚ç”¨çš„ä¸åŠ³åŠ¨å’Œå°±ä¸šç›¸å…³æ³•å¾‹ã€æ³•è§„ã€è§„åˆ™å’Œæ ‡å‡†ã€‚å¦‚æœè¯¥å¸æ³•ç®¡è¾–åŒº
æ²¡æœ‰æ­¤ç±»æ³•å¾‹ã€æ³•è§„ã€è§„ç« å’Œæ ‡å‡†æˆ–å…¶æ³•å¾‹ã€æ³•è§„ã€è§„ç« å’Œæ ‡å‡†ä¸å¯æ‰§è¡Œï¼Œåˆ™ä¸ªäººæˆ–æ³•äººå®ä½“å¿…é¡»éµå®ˆå›½é™…
åŠ³å·¥æ ‡å‡†çš„æ ¸å¿ƒå…¬çº¦ã€‚
3. ä¸ªäººæˆ–æ³•äººä¸å¾—ä»¥ä»»ä½•æ–¹å¼è¯±å¯¼ã€æš—ç¤ºæˆ–å¼ºè¿«å…¶å…¨èŒæˆ–å…¼èŒå‘˜å·¥æˆ–å…¶ç‹¬ç«‹æ‰¿åŒ…äººä»¥å£å¤´æˆ–ä¹¦é¢å½¢å¼åŒæ„
ç›´æ¥æˆ–é—´æ¥é™åˆ¶ã€å‰Šå¼±æˆ–æ”¾å¼ƒå…¶æ‰€æ‹¥æœ‰çš„ï¼Œå—ç›¸å…³ä¸åŠ³åŠ¨å’Œå°±ä¸šæœ‰å…³çš„æ³•å¾‹ã€æ³•è§„ã€è§„åˆ™å’Œæ ‡å‡†ä¿æŠ¤çš„æƒåˆ©
æˆ–è¡¥æ•‘æªæ–½ï¼Œæ— è®ºè¯¥ç­‰ä¹¦é¢æˆ–å£å¤´åè®®æ˜¯å¦è¢«è¯¥å¸æ³•ç®¡è¾–åŒºçš„æ³•å¾‹æ‰€æ‰¿è®¤ï¼Œè¯¥ç­‰ä¸ªäººæˆ–æ³•äººå®ä½“ä¹Ÿä¸å¾—ä»¥ä»»
ä½•æ–¹æ³•é™åˆ¶å…¶é›‡å‘˜æˆ–ç‹¬ç«‹æ‰¿åŒ…äººå‘ç‰ˆæƒæŒæœ‰äººæˆ–ç›‘ç£è®¸å¯è¯åˆè§„æƒ…å†µçš„æœ‰å…³å½“å±€æŠ¥å‘Šæˆ–æŠ•è¯‰ä¸Šè¿°è¿åè®¸å¯è¯
çš„è¡Œä¸ºçš„æƒåˆ©ã€‚

è¯¥æˆæƒä½œå“æ˜¯"æŒ‰åŸæ ·"æä¾›ï¼Œä¸åšä»»ä½•æ˜ç¤ºæˆ–æš—ç¤ºçš„ä¿è¯ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå¯¹é€‚é”€æ€§ã€ç‰¹å®šç”¨é€”é€‚ç”¨æ€§å’Œéä¾µ
æƒæ€§çš„ä¿è¯ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œæ— è®ºæ˜¯åœ¨åˆåŒè¯‰è®¼ã€ä¾µæƒè¯‰è®¼æˆ–å…¶ä»–è¯‰è®¼ä¸­ï¼Œç‰ˆæƒæŒæœ‰äººå‡ä¸æ‰¿æ‹…å› æœ¬è½¯ä»¶æˆ–
æœ¬è½¯ä»¶çš„ä½¿ç”¨æˆ–å…¶ä»–äº¤æ˜“è€Œäº§ç”Ÿã€å¼•èµ·æˆ–ä¸ä¹‹ç›¸å…³çš„ä»»ä½•ç´¢èµ”ã€æŸå®³æˆ–å…¶ä»–è´£ä»»ã€‚

----------

â€œæ­»å¦ˆçš„é˜²æ²‰è¿·â€è®¸å¯è¯ã€€ç¬¬ä¸€ç‰ˆï¼ˆè‰æ¡ˆï¼‰

ç‰ˆæƒæ‰€æœ‰ã€€ï¼ˆcï¼‰ã€€2022ã€€dsy4567ï¼ˆhttps://github.com/dsy4567/ ; dsy4567@outlook.comï¼‰

ç®€ä»‹

  ã€Šâ€œæ­»å¦ˆçš„é˜²æ²‰è¿·â€è®¸å¯è¯ã€‹æ˜¯ä¸€ä»½é¢å‘è½¯ä»¶åŠå…¶ä»–ç±»å‹ä½œå“çš„ç‰ˆæƒè®¸å¯åè®®ï¼Œå®ƒæ—¨åœ¨åˆ¶çº¦åˆ¶å®šã€å®æ–½
æˆ–éµå®ˆé˜²æ²‰è¿·é€šçŸ¥ä»¥åŠä¸ºä¸Šè¿°è¡Œä¸ºæä¾›æ¡ä»¶æˆ–ä¾¿åˆ©çš„ä¸ªäººæˆ–æ³•äººå®ä½“çš„å‘å±•ï¼Œå¹¶å¼ºè¿«è¿™äº›ä¸ªäººæˆ–æ³•äººå®ä½“æƒ
è¡¡è‡ªèº«è¡Œä¸ºã€‚

  ä¸‹æ–‡æ˜¯æœ‰å…³ä½¿ç”¨ã€å¤åˆ¶ã€ä¿®æ”¹ã€è¡ç”Ÿåˆ©ç”¨ã€æ•£å¸ƒã€å‘å¸ƒå’Œå†è®¸å¯çš„ä¸¥è°¨æè¿°å’Œå®æ–½æ¡ä»¶ã€‚

ã€‡ã€å®šä¹‰

  â€œæœ¬è®¸å¯è¯â€æŒ‡ã€Šâ€œæ­»å¦ˆçš„é˜²æ²‰è¿·â€è®¸å¯è¯ã€€ç¬¬ä¸€ç‰ˆï¼ˆè‰æ¡ˆï¼‰ã€‹ï¼›
  â€œæœ¬ä½œå“â€æŒ‡ä»»ä½•åœ¨æœ¬è®¸å¯è¯ä¿æŠ¤ä¸‹çš„æœ‰ç‰ˆæƒçš„ä½œå“ï¼ˆåŒ…æ‹¬æºä»£ç ã€æ–‡ä»¶å’Œ/æˆ–ç›¸å…³å†…å®¹ï¼‰ï¼›
  â€œç‰ˆæƒæŒæœ‰äººâ€å¯ä»¥æ˜¯ä¸ªäººæˆ–æ³•äººå®ä½“ï¼›
  â€œæ‚¨â€æŒ‡æ¥æ”¶æœ¬ä½œå“çš„å‰¯æœ¬çš„ä¸ªäººæˆ–æ³•äººå®ä½“ï¼›
  â€œé˜²æ²‰è¿·é€šçŸ¥â€æŒ‡ã€Šå›½å®¶æ–°é—»å‡ºç‰ˆç½²å…³äºè¿›ä¸€æ­¥ä¸¥æ ¼ç®¡ç†ã€€åˆ‡å®é˜²æ­¢æœªæˆå¹´äººæ²‰è¿·ç½‘ç»œæ¸¸æˆçš„é€šçŸ¥ã€‹ï¼ˆå›½
æ–°å‡ºå‘ã€”2021ã€•14å·ï¼‰ï¼›<https://www.nppa.gov.cn/nppa/contents/279/98792.shtml>
  â€œä¸¾æŠ¥å¹³å°â€æŒ‡å›½å®¶æ–°é—»å‡ºç‰ˆç½²é˜²æ­¢æœªæˆå¹´äººæ²‰è¿·ç½‘ç»œæ¸¸æˆä¸¾æŠ¥å¹³å°ï¼›
<https://jubao.chinaso.com/>
  â€œå®åè®¤è¯ç³»ç»Ÿâ€æŒ‡ç½‘ç»œæ¸¸æˆé˜²æ²‰è¿·å®åè®¤è¯ç³»ç»Ÿã€‚
<https://wlc.nppa.gov.cn/fcm_company/index.html>

ä¸€ã€æœ¬ä½œå“çš„å¤„ç½®

  åœ¨ç¬¦åˆæœ¬è®¸å¯è¯çš„æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œæ— è®ºæ˜¯å‡ºäºå•†ä¸šç›®çš„è¿˜æ˜¯éå•†ä¸šç›®çš„ï¼Œæ‚¨æœ‰æƒä»¥ä»»ä½•æ–¹å¼å¤„ç½®æœ¬ä½œå“
ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºä½¿ç”¨ã€å¤åˆ¶ã€ä¿®æ”¹ã€è¡ç”Ÿåˆ©ç”¨ã€æ•£å¸ƒã€å‘å¸ƒå’Œå†è®¸å¯ï¼‰ï¼Œä¸”ä¸å¿…äº‹å…ˆå–å¾—ç‰ˆæƒæŒæœ‰äººçš„åŒæ„ã€‚

äºŒã€ç‰ˆæƒå£°æ˜

  æ‚¨å¿…é¡»åœ¨æˆæƒä½œå“çš„æ¯ä¸ªå†æ•£å¸ƒæˆ–è¡ç”Ÿå‰¯æœ¬ä¸ŠåŒ…å«ä»¥ä¸Šç‰ˆæƒå£°æ˜å’Œæœ¬è®¸å¯è¯ï¼Œä¸å¾—è‡ªè¡Œä¿®æ”¹ã€‚

ä¸‰ã€æ‚¨çš„è¡Œä¸ºçš„é™åˆ¶

  æ‚¨åªæœ‰æ»¡è¶³ä»¥ä¸‹æ¡ä»¶åï¼Œæ‰èƒ½å¤Ÿä½¿ç”¨ã€å¤åˆ¶ã€ä¿®æ”¹ã€è¡ç”Ÿåˆ©ç”¨ã€æ•£å¸ƒã€å‘å¸ƒæˆ–å†è®¸å¯æœ¬ä½œå“çš„å‰¯æœ¬ï¼š
  æ‚¨æœªéµå®ˆæˆ–å®æ–½é˜²æ²‰è¿·é€šçŸ¥å†…çš„ä»»ä½•è¦æ±‚ï¼Œä¸”æœªå‚ä¸æˆ–ç»„ç»‡é˜²æ²‰è¿·é€šçŸ¥çš„ç¼–å†™ã€åˆ¶å®šæˆ–ä¿®è®¢æ´»åŠ¨ï¼›
  æ‚¨æœªä¸ºä¸¾æŠ¥å¹³å°å’Œå®åè®¤è¯ç³»ç»ŸåŠå…¶è¡ç”Ÿå‰¯æœ¬çš„åˆ¶ä½œã€ä½¿ç”¨ã€å¤åˆ¶ã€ä¿®æ”¹ã€è¡ç”Ÿåˆ©ç”¨ã€æ•£å¸ƒã€å‘å¸ƒå’Œæ­£
å¸¸è¿è¥æä¾›æ¡ä»¶æˆ–ä¾¿åˆ©ï¼Œæˆ–åˆ¶ä½œã€ä½¿ç”¨ã€å¤åˆ¶ã€ä¿®æ”¹ã€è¡ç”Ÿåˆ©ç”¨ã€æ•£å¸ƒæˆ–å‘å¸ƒä¸¾æŠ¥å¹³å°æˆ–å®åè®¤è¯ç³»ç»ŸåŠå…¶
è¡ç”Ÿå‰¯æœ¬ï¼Œä¸”æœªç»„ç»‡æˆ–å‚ä¸ä¸¾æŠ¥å¹³å°æˆ–å®åè®¤è¯ç³»ç»Ÿçš„è¿è¥æˆ–ç»´æŠ¤æ´»åŠ¨ï¼›
  æ‚¨æœªä¸ä¸æ»¡è¶³ç¬¬ä¸‰æ¡æ¡ä»¶çš„å…¶ä»–ä¸ªäººæˆ–æ³•äººå®ä½“æœ‰éš¶å±ã€æŠ•èµ„æˆ–è¢«æŠ•èµ„å…³ç³»ã€‚

å››ã€ç»ˆæ­¢æˆæƒ

  è‡ªæ‚¨è¿åæœ¬è®¸å¯è¯ä¹‹æ—¥èµ·ï¼Œæ‚¨å°†å¤±å»ä½¿ç”¨ã€å¤åˆ¶ã€ä¿®æ”¹ã€è¡ç”Ÿåˆ©ç”¨ã€æ•£å¸ƒã€å‘å¸ƒæˆ–å†è®¸å¯æœ¬ä½œå“çš„æƒåˆ©
ï¼Œç›´åˆ°ç‰ˆæƒæŒæœ‰äººæ˜ç¡®æ¢å¤å¯¹æ‚¨çš„æˆæƒã€‚

äº”ã€å“è´¨æ‹…ä¿å’Œå…è´£å£°æ˜

  åœ¨é€‚ç”¨çš„æ³•å¾‹èŒƒå›´å†…ï¼Œé™¤éå¦æœ‰ä¹¦é¢è¯´æ˜ï¼Œå¦åˆ™ç‰ˆæƒæŒæœ‰äººä¸å¯¹æœ¬ä½œå“çš„å“è´¨ä½œä»»ä½•æ‹…ä¿ï¼Œå¦‚æœæœ¬ä½œå“
çš„ç¼ºé™·ï¼ˆä¾‹å¦‚ç¨‹åºçš„è´¨é‡å’Œæ€§èƒ½é—®é¢˜ï¼‰å¼•å‘äº†ä»»ä½•ç¨‹åº¦çš„æŸå¤±å’Œåæœï¼ˆä¾‹å¦‚æ•°æ®ä¸¢å¤±æˆ–æŸåã€æ— æ³•ä¸å…¶ä»–ç¨‹
åºååŒå·¥ä½œï¼‰ï¼Œé‚£ä¹ˆç‰ˆæƒæŒæœ‰äººä¸ä¸ºæ­¤æ‰¿æ‹…ä»»ä½•è´£ä»»ï¼Œå³ä½¿ä»–ï¼ˆä»¬ï¼‰å£°ç§°æœ¬ä½œå“æ²¡æœ‰ä»»ä½•ç¼ºé™·ï¼Œä¸”æ‚¨éœ€è¦è‡ª
è¡Œæ‰¿æ‹…ä¸ºæ­¤èŠ±è´¹çš„ä¿®å¤è´¹ç”¨æˆ–å…¶ä»–å¿…è¦è´¹ç”¨ä»¥åŠæŸå¤±å’Œè´£ä»»ã€‚

  æ¡æ¬¾å’Œæ¡ä»¶ç»“æŸã€‚
*/
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.activate = void 0;
const vscode = require("vscode");
const cheerio = require("cheerio");
const axios_1 = require("axios");
const iconv = require("iconv-lite");
const http = require("http");
const cookie = require("cookie");
const fs = require("fs");
const os = require("os");
const path = require("path");
const mime = require("mime");
const isLocalhost = require("is-localhost-ip");
let COOKIE;
/** æ¸¸æˆå…¥å£æ–‡ä»¶ */
let DATA;
let HTTP_SERVER;
let PORT = 44399;
/** è¦†ç›–ç”¨æˆ·è®¾ç½®çš„ referer, ä»…ç”¨äºæœ¬åœ°æœåŠ¡å™¨(è¯·å°½é‡ä½¿ç”¨ initHttpServer() å‡½æ•°è®¾ç½®è¯¥å€¼) */
let REF;
/** e.g. szhong.4399.com */
let server = "";
/** e.g. /4399swf/upload_swf/ftp39/cwb/20220706/01a/index.html */
let gamePath = "";
/** e.g. https://szhong.4399.com/4399swf/upload_swf/ftp39/cwb/20220706/01a/index.html */
let gameUrl = "";
/** e.g. {"åŸå§‹äººéƒ¨è½": "https://www.4399.com/flash/230924.htm"} */
let gameInfoUrls = {};
/** e.g. https://client-zmxyol.3304399.net/client/?... */
let webGameUrl = "";
let isFlashGame = false;
let alerted = false; // ç¬¬ä¸€æ¬¡æ¸¸æˆå‰æç¤º
/** Webview é¢æ¿ */
let panel;
/** æ‰©å±•ä¸Šä¸‹æ–‡ */
let context;
/** åŠ è½½æç¤ºçŠ¶æ€æ é¡¹ */
let statusBarItem = vscode.window.createStatusBarItem(1);
// ç¾¤ç»„ç›¸å…³
let threadQp;
let threadQpItems = [];
/** å·²è¾“å…¥çš„æœç´¢è¯ */
let threadSearchValue;
/** é¡µç  */
let threadPage = 1;
/** e.g. threadData[0] == ["é€ æ¢¦æ— åŒ", 84526] */
let threadData;
/** e.g. threads["é€ æ¢¦æ— åŒ"] == 84526 */
let threads = {};
/** å»¶è¿Ÿè·å–æœç´¢å»ºè®® */
let threadTimeout;
// æœç´¢ç›¸å…³
let searchQp;
let searchQpItems = [];
/** å·²è¾“å…¥çš„æœç´¢è¯ */
let searchValue;
/** é¡µç  */
let searchPage = 1;
/** e.g. searchData[0] == ["é€ æ¢¦æ— åŒ", 210650] */
let searchData;
/** e.g. searchedGames["é€ æ¢¦æ— åŒ"] == 210650 */
let searchedGames = {};
/** å»¶è¿Ÿè·å–æœç´¢å»ºè®® */
let searchTimeout;
/** e.g. "C:\users\you\.4ov-data\", "/home/you/.4ov-data/" */
const DATA_DIR = path.join(os.userInfo().homedir, ".4ov-data/");
/** Service Worker ä»£ç  */
const getServiceWorker = () => {
    try {
        return require("./sw").code;
    }
    catch (e) {
        err("æ— æ³•è·å– ServiceWorker ä»£ç ", e);
        return "";
    }
};
/** è·å–è¦æ³¨å…¥çš„ HTML ä»£ç ç‰‡æ®µ */
const getScript = (cookie = "", fullWebServerUri, includeDefaultScript = true) => {
    if (!getCfg("injectionScripts", true))
        return getCfg("enableProxy") && getCfg("enableServiceWorker")
            ? 'navigator.serviceWorker.register("/sw-4ov.js");'
            : "navigator.serviceWorker.getRegistrations().then((r)=>{r.forEach(sw=>sw.unregister())})";
    let s = "", f = (getCfg("scripts") || "").split(", ");
    f.forEach(file => {
        if (file)
            try {
                s += fs
                    .readFileSync(path.join(DATA_DIR, "html-scripts/", file))
                    .toString();
            }
            catch (e) {
                err(`è¯»å– HTML ä»£ç ç‰‡æ®µæ–‡ä»¶ ${path.join(DATA_DIR, "html-scripts/", file)} æ—¶å‡ºé”™`, e);
            }
    });
    return ((includeDefaultScript
        ? `
<style>
html, body {
    overflow: hidden;
    margin: 0;
    padding: 0;
}

p.tip4ov {
    color: #888;
    position: absolute;
    top: 0;
    z-index: -1;
}
</style>
<script>
// å¼ºåˆ¶è®¾ç½® referrer
Object.defineProperty(document, "referrer", {
    value: "https://www.4399.com/",
    writable: true,
});
// å¼ºåˆ¶è®¾ç½® cookie
Object.defineProperty(document, "cookie", {
    value: \`${is4399Domain(server) ? cookie.replaceAll(";", "; ") : ""}\`,
    writable: false,
});
// è®¾ç½® document.domain ä¸ä¼šæŠ¥é”™
Object.defineProperty(document, "domain", {
    value: "4399.com",
    writable: true,
});
// æ‰“å¼€é“¾æ¥
Object.defineProperty(window, "open", {
    value: (url) => {
        console.log(url);
        fetch("/_4ov/openUrl/" + url);
    },
    writable: true,
});
// åŠ è½½æç¤º
document.documentElement.insertAdjacentHTML("beforeend", "<p class='tip4ov'>æ¸¸æˆæ­£åœ¨åŠ è½½ï¼Œç¬¬ä¸€æ¬¡åŠ è½½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</p>");

${getCfg("enableProxy") && getCfg("enableServiceWorker")
            ? 'navigator.serviceWorker.register("/sw-4ov.js");'
            : "navigator.serviceWorker.getRegistrations().then((r)=>{r.forEach(sw=>sw.unregister())})"}
</script>
`
        : "") +
        `
<script>
    const FULL_WEB_SERVER_URI = "${fullWebServerUri}";
    const PORT = ${PORT}
</script>` +
        s);
};
const getWebviewHtml_h5 = (fullWebServerUri, cspSource = "", w = "100%", h = "100vh") => `
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>4399</title>
        <base target="_self" />
    </head>

    <body>
        <style>
            ::-webkit-scrollbar {
                display: none !important;
            }

            html, body {
                overflow: hidden;
                margin: 0;
                padding: 0;
            }


            iframe {
                width: ${typeof w === "string" ? w : w + "%"};
                height: ${typeof h === "string" ? h.replace("%", "vh") : h + "vh"};
            }

            p {
                color: #888;
                position: absolute;
                top: 0;
                z-index: -1;
            }
        </style>
        <iframe id="ifr" src="" frameborder="0"></iframe>
        <p>æ¸¸æˆæ­£åœ¨åŠ è½½ï¼Œç¬¬ä¸€æ¬¡åŠ è½½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
        <script>
            const IFR_FULL_WEB_SERVER_URI = "${String(fullWebServerUri)}".replaceAll("%3D","=").replaceAll("%26","&")
            console.log(IFR_FULL_WEB_SERVER_URI);
            ifr.src = IFR_FULL_WEB_SERVER_URI;
        </script>
    </body>
</html>

`;
const getWebviewHtml_flash = (fullWebServerUri, cspSource = "", w = "100%", h = "100%") => `
<!DOCTYPE html>
<html style="height: 100%;margin: 0;padding: 0;">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0"
        />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>flash æ’­æ”¾å™¨(Ruffle å¼•æ“)</title>
        <style>
            ::-webkit-scrollbar {
                display: none !important;
            }

            html, body {
                overflow: hidden;
                margin: 0;
                padding: 0;
            }
        </style>
        <script>
            // æ‰“å¼€é“¾æ¥
            Object.defineProperty(window, "open", {
                value: (url) => {
                    console.log(url);
                    fetch("/_4ov/openUrl/" + url);
                },
                writable: true,
            });
            ${getCfg("enableProxy") && getCfg("enableServiceWorker")
    ? 'navigator.serviceWorker.register("/sw-4ov.js");'
    : "navigator.serviceWorker.getRegistrations().then((r)=>{r.forEach(sw=>sw.unregister())})"}
        </script>
        ${getScript("", fullWebServerUri, false)}
        <script>
            window.play = function (url) {
                var html =
                    '<object id="flashgame" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="//download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=10,0,0,0" width="100%" height="100%"><param id="game" name="movie" value="' +
                    url +
                    '" /><embed id="flashgame1" name="flashgame" src="' +
                    url +
                    '" quality="high" pluginspage="//www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" width="${typeof w === "string" ? w : w + "%"}" height="${typeof h === "string" ? h : h + "%"}" /> <param name="quality" value="high" /></object>';
                document.body.innerHTML =html
            };
        </script>
        <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
    </head>
    <body style="height: 100%;margin: 0;padding: 0;">
        <p style=color #888;">æ¸¸æˆæ­£åœ¨åŠ è½½ï¼Œç¬¬ä¸€æ¬¡åŠ è½½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
        <script>
            const IFR_FULL_WEB_SERVER_URI = "${String(fullWebServerUri)}".replaceAll("%3D","=").replaceAll("%26","&")
            let u = new URL(IFR_FULL_WEB_SERVER_URI)
            u.path = "/_4ov/flash"
            console.log(u);
            window.play(u);
        </script>
    </body>
</html>
`;
/**
 * å…¨å±€å­˜å‚¨
 * @param context æ‰©å±•ä¸Šä¸‹æ–‡
 */
const globalStorage = (context) => {
    return {
        get: (key) => JSON.parse(context.globalState.get(key) || '""'),
        set: (key, value) => context.globalState.update(key, JSON.stringify(value)),
    };
};
/**
 * å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨, åŒ…å«æœ¬åœ°æœåŠ¡å™¨è¿è¡Œæ—¶çš„ç›¸å…³ä»£ç 
 * @param callback æœåŠ¡å™¨å¯åŠ¨åè¦æ‰§è¡Œçš„å›è°ƒ
 * @param ref è¦†ç›–ç”¨æˆ·è®¾ç½®çš„ referer
 */
function initHttpServer(callback, ref) {
    REF = ref;
    let onRequest = async (request, response) => {
        function log(...p) { } // NOTE: åœ¨éœ€è¦è¾“å‡ºç½‘ç»œè¯·æ±‚ç›¸å…³æ—¥å¿—æ—¶éœ€è¦æ³¨é‡Šæ‰è¿™è¡Œä»£ç 
        log(request.url, request);
        try {
            if (!request?.url)
                response.end(null);
            else if (request.url.includes("_4ov-flash-player.htm"))
                response.end(getWebviewHtml_flash(await vscode.env.asExternalUri(vscode.Uri.parse(`http://127.0.0.1:${PORT}/_4ov/flash`))));
            else if (request.url === "/_4ov/webGame") {
                response.writeHead(302, {
                    Location: webGameUrl,
                });
                response.end();
            }
            else if (request.url === "/_4ov/flash") {
                response.writeHead(302, {
                    Location: gamePath,
                });
                response.end();
            }
            else if (request.url === "/") {
                log("è®¿é—®æ ¹ç›®å½•ç›´æ¥è·³è½¬åˆ°æ¸¸æˆå…¥å£é¡µé¢");
                gamePath !== "/"
                    ? response.writeHead(302, {
                        Location: isFlashGame
                            ? new URL("./_4ov-flash-player.html", gameUrl)
                                .pathname
                            : gamePath,
                    })
                    : response.writeHead(500, {}); // é˜²æ­¢é‡å¤é‡å®šå‘
                response.end();
            }
            else if (request.url.startsWith("/_4ov/stop/")) {
                if (request.url.startsWith("/_4ov/stop/" +
                    globalStorage(context).get("stop-secret"))) {
                    response.end(null);
                    HTTP_SERVER?.close();
                    HTTP_SERVER = undefined;
                    log("æœ¬åœ°æœåŠ¡å™¨å·²åœæ­¢");
                }
            }
            else if (request.url.startsWith("/_4ov/proxy/")) {
                log("ä»£ç†è¯·æ±‚", REF);
                let u = new URL(request.url.substring("/_4ov/proxy/".length), "https://www.4399.com");
                if (await isLocalhost(u.hostname))
                    return response.end(null);
                if (!getCfg("enableProxy", true)) {
                    response.writeHead(302, {
                        Location: "" + u,
                    });
                    return response.end(null);
                }
                let data = "";
                request.on("data", function (chunk) {
                    data += chunk;
                });
                request.on("end", function () {
                    let config = {
                        data,
                        url: "" + u,
                        method: request.method,
                        responseType: "arraybuffer",
                        headers: request.headers || {},
                        validateStatus: () => true,
                    };
                    config.headers["user-agent"] = getCfg("user-agent");
                    config.headers["referer"] =
                        REF || "https://" + server + "/";
                    config.headers["cookie"] =
                        is4399Domain(u.hostname) &&
                            getCfg("requestWithCookieOn4399Domain")
                            ? COOKIE
                            : "";
                    axios_1.default
                        .request(config)
                        .then(res => {
                        let headers = res.headers;
                        getCfg("allowCrossOriginWhenNot4399Domain") &&
                            (headers["access-control-allow-origin"] = "*");
                        headers["content-length"] = "";
                        response.writeHead(res.status, headers);
                        response.statusMessage = res.statusText;
                        response.end(res.data);
                    })
                        .catch(e => {
                        response.writeHead(500, {
                            "content-type": "text/plain",
                        });
                        response.statusMessage = e.message;
                        response.end(e.message);
                    });
                });
            }
            else if (request.url.startsWith("/_4ov/openUrl/") &&
                getCfg("openUrl", true)) {
                log("æ‰“å¼€å¤–é“¾/æ¨èæ¸¸æˆ");
                response.end(null);
                let u;
                try {
                    u = new URL(request.url
                        .substring("/_4ov/openUrl/".length)
                        .replaceAll("127.0.0.1%3A" + PORT, server), "https://www.4399.com/");
                }
                catch (e) {
                    openUrl(request.url.substring("/_4ov/openUrl/".length));
                    return;
                }
                if (u.hostname.endsWith(".4399.com") &&
                    u.pathname.startsWith("/flash/"))
                    getPlayUrl(u.href);
                else if (u.hostname === "sbai.4399.com" &&
                    u.searchParams.get("4399id"))
                    getPlayUrl("https://www.4399.com/flash/" +
                        u.searchParams.get("4399id") +
                        ".htm");
                else
                    openUrl("" + u);
            }
            else if (request.url.startsWith("/sw-4ov.js")) {
                response.writeHead(200, { "content-type": "text/javascript" });
                response.end(getServiceWorker());
            }
            else if (request.url.startsWith("/favicon.ico")) {
                response.writeHead(302, {
                    Location: "https://dsy4567.github.io/icon.png",
                });
                response.end();
            }
            else if (new URL(request.url, "http://127.0.0.1:" + PORT).pathname ===
                gamePath) {
                log("è®¿é—®æ¸¸æˆå…¥å£é¡µé¢ç›´æ¥è¿”å›æ•°æ®");
                response.writeHead(200, {
                    "content-security-policy": "allow-pointer-lock allow-scripts",
                    "content-type": mime.getType(request.url || "") ||
                        "text/html" + "; charset=utf-8",
                    "access-control-allow-origin": "*",
                });
                response.end(DATA);
            }
            else {
                log("å‘ 4399 æœåŠ¡å™¨è¯·æ±‚æ¸¸æˆæ–‡ä»¶");
                let config = getReqCfg("arraybuffer", false, REF);
                config.validateStatus = status => true;
                axios_1.default
                    .get("http://" + server + request.url, config)
                    .then(res => {
                    let headers = res.headers;
                    headers["access-control-allow-origin"] = "*";
                    response.writeHead(res.status, headers);
                    response.statusMessage = res.statusText;
                    response.end(res.data);
                })
                    .catch(e => {
                    log(request, request.url);
                    response.writeHead(500, {
                        "content-type": "text/plain",
                    });
                    response.statusMessage = e.message;
                    response.end(e.message);
                });
            }
        }
        catch (e) {
            response.writeHead(500, {
                "content-type": "text/plain",
            });
            response.end(String(e));
        }
    };
    if (HTTP_SERVER)
        callback();
    else {
        PORT = Number(getCfg("port", 44399));
        if (isNaN(PORT))
            PORT = 44399;
        try {
            HTTP_SERVER = http
                .createServer(onRequest)
                .listen(PORT, "127.0.0.1", function () {
                log("æœ¬åœ°æœåŠ¡å™¨å·²å¯åŠ¨");
                callback();
            })
                .on("error", async (e) => {
                log("æ­£åœ¨å°è¯•å…³é—­å·²å¯åŠ¨çš„æœåŠ¡å™¨");
                try {
                    await axios_1.default.get("http://127.0.0.1:" +
                        PORT +
                        "/_4ov/stop/" +
                        globalStorage(context).get("stop-secret"), {
                        timeout: 3000,
                    });
                }
                catch (e) { }
                await (async () => {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            resolve(null);
                        }, 500);
                    });
                })();
                HTTP_SERVER = http
                    .createServer(onRequest)
                    .listen(PORT, "127.0.0.1", function () {
                    log("æœ¬åœ°æœåŠ¡å™¨å·²å¯åŠ¨");
                    callback();
                })
                    .on("error", e => {
                    err(e.stack);
                    HTTP_SERVER = undefined;
                });
            });
        }
        catch (e) {
            err(String(e));
            HTTP_SERVER = undefined;
        }
    }
}
/**
 * è·å–å‘èµ·è¯·æ±‚æ—¶çš„é…ç½®
 * @param responseType å“åº”ç±»å‹
 * @param noCookie æ˜¯å¦å¸¦ä¸Š cookie
 * @param ref referer
 * @returns Axios è¯·æ±‚é…ç½®
 */
function getReqCfg(responseType, noCookie = false, ref) {
    let c;
    if (!noCookie)
        c = getCookieSync();
    return {
        baseURL: "https://www.4399.com",
        responseType: responseType,
        headers: {
            "user-agent": getCfg("user-agent"),
            referer: ref || getCfg("referer"),
            cookie: c && !noCookie ? c : "",
        },
    };
}
/**
 * æ‰“å¼€é“¾æ¥
 * @param url é“¾æ¥
 */
function openUrl(url) {
    if (!url)
        return;
    let u = new URL(url, "https://www.4399.com/").href;
    vscode.env.openExternal(vscode.Uri.parse(u));
}
/** è¾“å‡ºæ—¥å¿—, å—ç”¨æˆ·é…ç½®å½±å“(æ¨èä¼˜å…ˆä½¿ç”¨) */
function log(...arg) {
    if (!getCfg("printLogs"))
        return;
    console.log("[4399 on VSCode]", ...arg);
}
/** æŠ¥é”™å¹¶æç¤ºç”¨æˆ·(ä»…åœ¨ç”¨æˆ·å¿…é¡»çŸ¥æƒ…æ—¶ä½¿ç”¨) */
function err(...arg) {
    vscode.window
        .showErrorMessage([...arg].join(" "), "åˆ‡æ¢å¼€å‘äººå‘˜å·¥å…·(Ctrl+Shift+I)", "åœ¨ GitHub ä¸ŠæŠ¥å‘Šé—®é¢˜")
        .then(val => {
        if (val === "åœ¨ GitHub ä¸ŠæŠ¥å‘Šé—®é¢˜")
            openUrl("https://github.com/dsy4567/4399-on-vscode/issues");
        else if (val === "åˆ‡æ¢å¼€å‘äººå‘˜å·¥å…·(Ctrl+Shift+I)")
            vscode.commands.executeCommand("workbench.action.webview.openDeveloperTools");
    });
    console.error("[4399 on VSCode]", ...arg);
    loaded(true);
}
/**
 * æ¸¸æˆå¼€å§‹/å®ŒæˆåŠ è½½æ—¶è°ƒç”¨
 * @param hide æ¸¸æˆæ˜¯å¦å·²åŠ è½½å®Œæ¯•
 */
function loaded(hide) {
    if (!statusBarItem.name)
        statusBarItem.text = "$(loading~spin) " + "æ¸¸æˆåŠ è½½ä¸­";
    hide ? statusBarItem.hide() : statusBarItem.show();
}
function createQuickPick(o) {
    return new Promise((resolve, reject) => {
        let qp = vscode.window.createQuickPick();
        qp.title = o.title;
        qp.value = o.value || "";
        qp.placeholder = o.prompt;
        qp.canSelectMany = false;
        qp.matchOnDescription = true;
        qp.matchOnDetail = true;
        qp.ignoreFocusOut = true;
        resolve(qp);
    });
}
/**
 * è·å–å·¥ä½œåŒºé…ç½®
 * @param name å»æ‰ "4399-on-vscode." åçš„é…ç½® ID
 * @param defaultValue æ‰¾ä¸åˆ°é…ç½®æ—¶çš„è¿”å›å€¼
 */
function getCfg(name, defaultValue = undefined) {
    return vscode.workspace
        .getConfiguration()
        .get("4399-on-vscode." + name, defaultValue);
}
/**
 * æ›´æ”¹å·¥ä½œåŒºé…ç½®
 * @param name å»æ‰ "4399-on-vscode." åçš„é…ç½® ID
 * @param val æ›´æ”¹åçš„é…ç½®å€¼
 */
function setCfg(name, val) {
    return vscode.workspace
        .getConfiguration()
        .update("4399-on-vscode." + name, val, true);
}
/**
 * è·å–å­˜æ”¾å°æ¸¸æˆçš„æœåŠ¡å™¨
 */
async function getServer(server_matched) {
    try {
        let res = await axios_1.default.get("https://www.4399.com" + server_matched[0].split('"')[1], getReqCfg("text", true));
        if (res.data) {
            log("æˆåŠŸè·å–åˆ°å®šä¹‰æ¸¸æˆæœåŠ¡å™¨çš„è„šæœ¬");
            return res.data.split('"')[1].split("/")[2];
        }
        else
            throw new Error("æ— æ³•è·å–å®šä¹‰æ¸¸æˆæœåŠ¡å™¨çš„è„šæœ¬: å“åº”æ–‡æœ¬ä¸ºç©º, æ‚¨å¯èƒ½éœ€è¦é…ç½® UA æˆ–ç™»å½•è´¦å·");
    }
    catch (e) {
        console.error(e);
        return (server_matched[0]
            .split('"')[1]
            .replace("/js/server", "")
            .replace(".js", "") + ".4399.com");
    }
}
/**
 * è·å– h5 é¡µæ¸¸çš„çœŸå®åœ°å€
 * @param urlOrId æ¸¸æˆè¯¦æƒ…é¡µé“¾æ¥æˆ–æ¸¸æˆ ID(å­—ç¬¦ä¸²)
 */
function getPlayUrlForWebGames(urlOrId) {
    login(async (c) => {
        loaded(false);
        let gameId = parseId(urlOrId);
        if (!gameId || isNaN(gameId))
            return err("h5 é¡µæ¸¸é“¾æ¥æ ¼å¼ä¸æ­£ç¡®");
        try {
            let cookieValue = cookie.parse(c)["Pauth"];
            if (!cookieValue)
                return err("cookie æ²¡æœ‰ Pauth çš„å€¼");
            let data = (await axios_1.default.post("https://h.api.4399.com/intermodal/user/grant2", "gameId=" +
                gameId +
                "&authType=cookie&cookieValue=" +
                cookieValue, getReqCfg("json"))).data;
            if (data.data?.game?.gameUrl &&
                data.data.game.gameUrl !== "&addiction=0") {
                log(data);
                let url = "https://www.zxwyouxi.com/g/" + gameId;
                let title = decodeURI(data.data.game.gameName);
                title = title || url;
                try {
                    gameInfoUrls[title] =
                        "https://www.4399.com/flash/" +
                            data.data.game.mainId +
                            ".htm";
                }
                catch (e) { }
                try {
                    let D = new Date();
                    updateHistory({
                        date: ` (${D.getFullYear()}å¹´${D.getMonth() + 1}æœˆ${D.getDate()}æ—¥${D.getHours()}æ—¶${D.getMinutes()}åˆ†)`,
                        name: title,
                        webGame: true,
                        url: url,
                    });
                }
                catch (e) {
                    err("å†™å…¥å†å²è®°å½•å¤±è´¥", String(e));
                }
                showWebviewPanel((webGameUrl = data.data.game.gameUrl), title, "", true, false);
            }
            else
                err("æ— æ³•ç™»å½•æ¸¸æˆ, æˆ–è€…æ ¹æœ¬æ²¡æœ‰è¿™ä¸ªæ¸¸æˆ");
        }
        catch (e) {
            err("æ— æ³•è·å–æ¸¸æˆé¡µé¢", String(e));
        }
    });
}
/**
 * è·å–æ™®é€šå°æ¸¸æˆçš„çœŸå®åœ°å€
 * @param url æ¸¸æˆè¯¦æƒ…é¡µé“¾æ¥
 */
async function getPlayUrl(url) {
    if (url.startsWith("//"))
        url = "https:" + url;
    else if (url.startsWith("/"))
        url = "https://www.4399.com" + url;
    try {
        loaded(false);
        let res = await axios_1.default.get(url, getReqCfg("arraybuffer"));
        if (res.data) {
            res.data = iconv.decode(res.data, "gb2312");
            log("æˆåŠŸè·å–åˆ°æ¸¸æˆé¡µé¢");
            const $ = cheerio.load(res.data);
            const html = $.html();
            if (!html)
                return err("æ— æ³•è·å–æ¸¸æˆé¡µé¢: html ä¸ºç©º, æ‚¨å¯èƒ½éœ€è¦é…ç½® UA æˆ–ç™»å½•è´¦å·(é”™è¯¯å‘ç”Ÿåœ¨è·å–æ¸¸æˆè¯¦æƒ…é¡µé˜¶æ®µ)");
            let title = "";
            let m = null;
            m = html.match(/<title>.+<\/title>/i);
            if (!m)
                title = $("title").html();
            else
                try {
                    title = m[0]
                        .replace(/<\/?title>/gi, "")
                        .split(/[-_ |ï¼Œ,Â¦]/gi)[0]
                        .replaceAll(/[\n ]/gi, "");
                }
                catch (e) {
                    title = $("title").html();
                    err("æ— æ³•åŒ¹é…æ¸¸æˆæ ‡é¢˜:", e);
                }
            let server_matched = html
                .replaceAll(" ", "")
                .match(/src\=\"\/js\/((server|s[0-9]).*|nitrome)\.js\"/i);
            let gamePath_matched = html.match(/\_strGamePath\=\".+\.(swf|htm[l]?)(\?.+)?\"/i);
            title = title || url;
            if ($("title").text().includes("æ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨ï¼") &&
                res.status) {
                delete gameInfoUrls[title];
                return err("æ— æ³•è·å–æ¸¸æˆä¿¡æ¯: æ¸¸æˆå¯èƒ½å› ä¸ºæŸäº›åŸå› è¢«åˆ é™¤");
            }
            gameInfoUrls[title] = url;
            if (!server_matched || !gamePath_matched) {
                // æ¸¸æˆå¯èƒ½æ˜¯ h5 é¡µæ¸¸
                let u1 = $("iframe#flash22").attr("src");
                let u2 = $("a.start-btn").attr("href");
                if (u1)
                    return getPlayUrlForWebGames(u1);
                if (u2)
                    return getPlayUrlForWebGames(u2);
                delete gameInfoUrls[title];
                err("æ­£åˆ™åŒ¹é…ç»“æœä¸ºç©º, æ­¤æ‰©å±•å¯èƒ½å‡ºç°äº†é—®é¢˜, ä¹Ÿå¯èƒ½å› ä¸ºè¿™ä¸ªæ¸¸æˆç±»å‹ä¸å—æ”¯æŒ, å·²è‡ªåŠ¨ä¸ºæ‚¨è·³è½¬è‡³æ¸¸æˆè¯¦æƒ…é¡µé¢");
                return showWebviewPanel(url, title);
            }
            gamePath =
                "/4399swf" +
                    gamePath_matched[0]
                        .replaceAll(" ", "")
                        .replace("_strGamePath=", "")
                        .replace(/["]/g, "");
            if (gamePath.includes("gameId="))
                try {
                    let u = new URL(gamePath, "https://www.4399.com/");
                    let i = u.searchParams.get("gameId");
                    if (i && !isNaN(Number(i)))
                        return getPlayUrlForWebGames(i);
                }
                catch (e) { }
            try {
                let D = new Date();
                updateHistory({
                    date: ` (${D.getFullYear()}å¹´${D.getMonth() + 1}æœˆ${D.getDate()}æ—¥${D.getHours()}æ—¶${D.getMinutes()}åˆ†)`,
                    name: title,
                    webGame: false,
                    url: url,
                });
            }
            catch (e) {
                err("å†™å…¥å†å²è®°å½•å¤±è´¥", String(e));
            }
            let s = await getServer(server_matched);
            log("æœåŠ¡å™¨", s);
            let isFlashPage = false;
            // ç®€å•åœ°åˆ¤æ–­åŸŸåæ˜¯å¦æœ‰æ•ˆ
            if ((await isLocalhost(s)) || /[/:?#\\=&]/g.test(s))
                return err("æ¸¸æˆæœåŠ¡å™¨åŸŸå " + s + " éæ³•");
            if (!is4399Domain(s) &&
                (await vscode.window.showWarningMessage("æ¸¸æˆæœåŠ¡å™¨åŸŸå " +
                    s +
                    " ä¸ä»¥ 4399.com ç»“å°¾, æ˜¯å¦ä»è¦å¼€å§‹æ¸¸æˆ", "æ˜¯", "å¦")) !== "æ˜¯")
                return;
            server = s;
            gameUrl = "https://" + s + gamePath;
            if (gameUrl) {
                if (!$("#skinbody > div:nth-child(7) > div.fl-box > div.intr.cf > div.eqwrap")[0] &&
                    !gamePath.includes(".swf"))
                    isFlashPage = true;
                try {
                    res = await axios_1.default.get(gameUrl, getReqCfg("arraybuffer"));
                    if (!res.data)
                        return err("æ— æ³•è·å–æ¸¸æˆé¡µé¢: html ä¸ºç©º, æ‚¨å¯èƒ½éœ€è¦é…ç½® UA æˆ–ç™»å½•è´¦å· (é”™è¯¯å‘ç”Ÿåœ¨å¤„ç†æ¸¸æˆçœŸå®é¡µé¢é˜¶æ®µ)");
                    if (isFlashPage &&
                        res.headers["content-type"]
                            .toLocaleLowerCase()
                            .includes("html")) {
                        let m = iconv.decode(res.data, "gb2312").match(/<embed.+src=".+.swf/i);
                        if (m) {
                            let fileName = m[0].split('"').at(-1);
                            if (fileName.includes("gameloader.swf")) {
                                m = fileName.match(/gameswf=.+.swf/);
                                if (m)
                                    fileName = m[0].split("=").at(-1);
                            }
                            gameUrl = gameUrl.replace(gameUrl.split("/").at(-1), fileName);
                            let u = new URL(gameUrl);
                            gamePath = u.pathname;
                            res.data = (await axios_1.default.get(gameUrl, getReqCfg("arraybuffer"))).data;
                        }
                    }
                    if (res.data) {
                        log("æˆåŠŸè·å–åˆ°æ¸¸æˆçœŸå®é¡µé¢", gameUrl);
                        initHttpServer(() => {
                            DATA = res.data;
                            let u = new URL(gamePath, "http://127.0.0.1:" + PORT);
                            u.port = String(PORT);
                            title = title || url;
                            showWebviewPanel("http://127.0.0.1:" + PORT, title, gamePath.includes(".swf") && "fl", true);
                        });
                    }
                }
                catch (e) {
                    err("æ— æ³•è·å–æ¸¸æˆçœŸå®é¡µé¢: ", e);
                }
            }
            else
                return err("æ¸¸æˆçœŸå®åœ°å€ä¸ºç©º");
        }
        else {
            err("æ— æ³•è·å–æ¸¸æˆé¡µé¢: å“åº”æ–‡æœ¬ä¸ºç©º, æ‚¨å¯èƒ½éœ€è¦é…ç½® UA æˆ–ç™»å½•è´¦å·");
            log(res);
        }
    }
    catch (e) {
        err("æ— æ³•è·å–æ¸¸æˆé¡µé¢: ", e);
    }
}
/**
 * æœç´¢æ¸¸æˆ
 * @param s é»˜è®¤æœç´¢è¯
 */
async function searchGames(s) {
    if (searchQp)
        searchQp.show();
    // let data: [string, number][];
    // let items: vscode.QuickPickItem[] = [];
    // let games: Record<string, number> = {};
    // let timeout: NodeJS.Timeout;
    // let pageNum = 1;
    searchQp = await createQuickPick({
        value: String(s) || "",
        title: "4399 on VSCode: æœç´¢",
        prompt: "è¾“å…¥æœç´¢è¯",
    });
    const search = (s) => {
        searchQp.title = s + " çš„æœç´¢ç»“æœ";
        searchQp.busy = true;
        log("é¡µç  " + searchPage);
        axios_1.default
            .get("https://so2.4399.com/search/search.php?k=" +
            encodeURI(s) +
            "&p=" +
            searchPage, getReqCfg("arraybuffer"))
            .then(res => {
            if (res.data) {
                res.data = iconv.decode(res.data, "gb2312");
                log("æˆåŠŸè·å–åˆ°4399æœç´¢é¡µé¢");
                const $ = cheerio.load(res.data);
                searchedGames = {};
                searchData = [];
                searchQpItems = [];
                $("#skinbody > div.w_980.cf > div.anim > div > div > div.pop > b > a").each((i, elem) => {
                    let h = $(elem).html();
                    let u = $(elem).attr("href");
                    if (!h || !u)
                        return;
                    let id = Number(u.split(/[/.]/gi).at(-2));
                    let n = h
                        .replace(/<font color=['"]?red['"]?>/, "")
                        .replace("</font>", "");
                    if (!id || isNaN(id) || !n)
                        return;
                    searchData.push([n, id]);
                    searchedGames[n] = id;
                });
                searchData.forEach(g => {
                    searchQpItems.push({
                        label: g[0],
                        description: "æ¸¸æˆ ID: " + g[1],
                        alwaysShow: true,
                    });
                });
                searchQpItems.push({
                    label: "ä¸‹ä¸€é¡µ",
                    description: "åŠ è½½ä¸‹ä¸€é¡µå†…å®¹",
                    alwaysShow: true,
                });
                searchQp.items = searchQpItems;
                searchQp.busy = false;
            }
        })
            .catch(e => {
            err("æ— æ³•è·å–4399é¦–é¡µ: ", e);
        });
    };
    searchQp.onDidChangeValue(kwd => {
        if (kwd === searchValue)
            return (searchQp.items = searchQpItems);
        searchValue = kwd;
        searchQp.title = "4399 on VSCode: æœç´¢";
        searchPage = 1;
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchQp.busy = true;
            axios_1.default
                .get("https://so2.4399.com/search/lx.php?k=" + encodeURI(kwd), getReqCfg("arraybuffer"))
                .then(res => {
                if (!res.data)
                    return err("è·å–æœç´¢å»ºè®®å¤±è´¥");
                res.data = iconv.decode(res.data, "gb2312");
                let d = res.data;
                log(d);
                let m = d.split(" =")[1];
                searchedGames = {};
                searchData = [];
                searchQpItems = [];
                try {
                    if (!m)
                        throw new Error("");
                    searchData = JSON.parse(m.replaceAll("'", '"'));
                }
                catch (e) {
                    return err("è§£ææœç´¢å»ºè®®å¤±è´¥");
                }
                searchQpItems.push({
                    label: searchQp.value,
                    description: "ç›´æ¥æœç´¢",
                    alwaysShow: true,
                });
                searchData.forEach(g => {
                    searchQpItems.push({
                        label: g[0],
                        description: "æ¸¸æˆ ID: " + g[1],
                        alwaysShow: true,
                    });
                    searchedGames[g[0]] = g[1];
                });
                if (searchQpItems[0])
                    searchQp.items = searchQpItems;
                searchQp.busy = false;
            })
                .catch(e => {
                return err("è·å–æœç´¢å»ºè®®å¤±è´¥", String(e));
            });
        }, 1000);
    });
    searchQp.onDidAccept(() => {
        if (searchQp.activeItems[0].description === "ç›´æ¥æœç´¢")
            search(searchQp.value);
        else if (searchQp.activeItems[0].label === "ä¸‹ä¸€é¡µ") {
            searchPage++;
            search(searchQp.value);
        }
        else {
            getPlayUrl(`https://www.4399.com/flash/${searchedGames[searchQp.activeItems[0].label]}.htm`);
            searchQp.hide();
            globalStorage(context).set("kwd", searchQp.value);
        }
    });
    searchQp.show();
}
/**
 * æ˜¾ç¤ºæ¸¸æˆè¯¦ç»†ä¿¡æ¯
 * @param url æ¸¸æˆè¯¦æƒ…é¡µé“¾æ¥(å¯é€‰, ç•™ç©ºåˆ™æ˜¾ç¤ºå·²æ‰“å¼€çš„æ¸¸æˆ)
 */
async function showGameInfo(url) {
    let u = Object.keys(gameInfoUrls);
    if (url) {
    }
    else if (u.length === 1)
        url = gameInfoUrls[u[0]];
    else if (u[1]) {
        let n = await vscode.window.showQuickPick(u);
        url = gameInfoUrls[n || ""];
    }
    if (!url)
        return;
    let gameId = String(parseId(url));
    try {
        url = "https://www.4399.com/flash/" + gameId + ".htm";
        const html = iconv.decode((await axios_1.default.get(url, getReqCfg("arraybuffer"))).data, "gb2312");
        if (!html)
            return err("æ— æ³•è·å–æ¸¸æˆé¡µé¢: html ä¸ºç©º, æ‚¨å¯èƒ½éœ€è¦é…ç½® UA æˆ–ç™»å½•è´¦å·(é”™è¯¯å‘ç”Ÿåœ¨è·å–æ¸¸æˆè¯¦æƒ…é¡µé˜¶æ®µ)");
        const $ = cheerio.load(html);
        const desc1 = $("#introduce > font").text().replaceAll(/[\n ]/gi, "");
        const desc2 = $("body > div.waper > div.content > div > div.box1.cf > div.intro.fl > div")
            .text()
            .replaceAll(/[\n ]/gi, "");
        const desc3 = $("body > div.main > div.w3.mb10 > div > div.bd_bg > div > div.w3_con1.cf > div.fl.con_l > div.cf.con_l1 > div.m11.fl > p")
            .text()
            .replaceAll(/[\n ]/gi, "");
        const desc4 = $("#cont").text().replaceAll(/[\n ]/gi, "");
        let desc = desc1 || desc2 || desc3 || desc4 || "æœªçŸ¥";
        let title = $("title")
            .text()
            .split(/[-_ |ï¼Œ,Â¦]/gi)[0]
            .replaceAll(/[\n ]/gi, "");
        title = title || "æœªçŸ¥";
        gameId = (isNaN(Number(gameId)) ? "æœªçŸ¥" : gameId) || "æœªçŸ¥";
        vscode.window
            .showQuickPick([
            "ğŸ® æ¸¸æˆå: " + title,
            "ğŸ“œ ç®€ä»‹: " + desc,
            "ğŸ†” æ¸¸æˆ ID: " + gameId,
            "â„¹ï¸ " + $("div.cls").text(),
            "â¤ï¸ æ·»åŠ åˆ°æ”¶è—ç›’",
            "ğŸŒ åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¦æƒ…é¡µé¢",
            "ğŸ’¬ çƒ­é—¨è¯„è®º",
        ])
            .then(async (item) => {
            if (item)
                try {
                    if (item.includes("æ·»åŠ åˆ°æ”¶è—ç›’"))
                        login(async () => {
                            try {
                                await axios_1.default.get("https://gprp.4399.com/cg/add_collection.php?gid=" +
                                    gameId, getReqCfg("json"));
                                vscode.window.showInformationMessage("æ·»åŠ åˆ°æ”¶è—ç›’æˆåŠŸ");
                            }
                            catch (e) {
                                err("æ·»åŠ åˆ°æ”¶è—ç›’å¤±è´¥", String(e));
                            }
                        });
                    else if (item.includes("åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¦æƒ…é¡µé¢"))
                        openUrl(url);
                    else if (item.includes("çƒ­é—¨è¯„è®º")) {
                        const html = iconv.decode((await axios_1.default.get("https://cdn.comment.4399pk.com/nhot-" +
                            gameId +
                            "-1.htm", getReqCfg("arraybuffer"))).data, "utf8");
                        if (!html)
                            return err("æ— æ³•è·å–æ¸¸æˆé¡µé¢: html ä¸ºç©º, æ‚¨å¯èƒ½éœ€è¦é…ç½® UA æˆ–ç™»å½•è´¦å·(é”™è¯¯å‘ç”Ÿåœ¨è·å–æ¸¸æˆè¯„è®ºé¡µé˜¶æ®µ)");
                        const $ = cheerio.load(html);
                        let items = [], tops = [];
                        $("#cntBox > div.zd > div.con").each((i, elem) => {
                            tops[i] = "[ç½®é¡¶è¯„è®º] " + $(elem).text();
                        });
                        $(".lam .tex").each((i, elem) => {
                            items[i] = $(elem).text();
                        });
                        items.unshift(...tops);
                        vscode.window.showQuickPick(items).then(item => {
                            if (item)
                                vscode.window.showInformationMessage(item);
                        });
                    }
                    else
                        vscode.window.showInformationMessage(item);
                }
                catch (e) {
                    err("æ— æ³•è·å–æ¸¸æˆé¡µé¢", String(e));
                }
        });
    }
    catch (e) {
        err("æ— æ³•è·å–æ¸¸æˆé¡µé¢", String(e));
    }
}
/**
 * æ˜¾ç¤º Webview é¢æ¿
 * @param url æ¸¸æˆé“¾æ¥
 * @param title æ¸¸æˆæ ‡é¢˜
 * @param type æ¸¸æˆç±»å‹(å¯ç•™ç©º, flash æ¸¸æˆ/å…¶ä»–)
 * @param hasIcon æ˜¾ç¤ºæ¸¸æˆå›¾æ ‡
 * @param asExternalUri æ²¡ç”¨
 */
async function showWebviewPanel(url, title, type, hasIcon, asExternalUri = true) {
    isFlashGame = !!type;
    const customTitle = getCfg("title");
    panel = vscode.window.createWebviewPanel("4399OnVscode", customTitle || title || "4399 on VSCode", vscode.ViewColumn.Active, {
        enableScripts: true,
        retainContextWhenHidden: getCfg("background", true),
        localResourceRoots: [],
    });
    panel.onDidDispose(() => {
        delete gameInfoUrls[title];
    });
    // æ‰“å¼€å¤–é“¾
    panel.webview.onDidReceiveMessage(m => {
        log(m);
        if (m.open && getCfg("openUrl", true))
            openUrl(m.open);
    }, undefined, context.subscriptions);
    // æ³¨å…¥è„šæœ¬
    if (new URL(url, "http://127.0.0.1:" + PORT).host === "127.0.0.1:" + PORT &&
        type !== "fl" &&
        getCfg("injectionScripts", true))
        try {
            if (gamePath.endsWith(".html") ||
                (gamePath.endsWith(".htm") && DATA)) {
                const $ = cheerio.load(typeof DATA === "string" ? DATA : iconv.decode(DATA, "utf8"));
                $("head").append(getScript(getCookieSync(), await vscode.env.asExternalUri(vscode.Uri.parse(`http://127.0.0.1:${PORT}`))));
                DATA = $.html();
            }
        }
        catch (e) {
            err("æ— æ³•ä¸ºæ¸¸æˆé¡µé¢æ³¨å…¥ä¼˜åŒ–è„šæœ¬", String(e));
        }
    panel.webview.html = getWebviewHtml_h5(asExternalUri
        ? await vscode.env.asExternalUri(vscode.Uri.parse(url))
        : url, panel.webview.cspSource);
    if (!alerted && getCfg("alert", true)) {
        alerted = true;
        vscode.window
            .showInformationMessage("æ¸©é¦¨æç¤º: è¯·åœ¨ä½¿ç”¨å¿«æ·é”®å‰ä½¿æ¸¸æˆå¤±å»ç„¦ç‚¹", "ä¸å†æç¤º")
            .then(val => setCfg("alert", false));
    }
    // è·å–æ¸¸æˆå›¾æ ‡
    let iconPath;
    let setIcon = () => {
        if (iconPath)
            panel.iconPath = {
                light: iconPath,
                dark: iconPath,
            };
    };
    if (hasIcon && getCfg("showIcon", true) && title)
        try {
            let gameId = (gameInfoUrls[title].split(/[/.]/gi).at(-2) || "").split("_")[0];
            if (gameId)
                if (fs.existsSync(path.join(DATA_DIR, `cache/icon/${gameId}.jpg`))) {
                    iconPath = vscode.Uri.file(path.join(DATA_DIR, `cache/icon/${gameId}.jpg`));
                    setIcon();
                }
                else
                    axios_1.default
                        .get(`https://imga1.5054399.com/upload_pic/minilogo/${gameId}.jpg`, getReqCfg("arraybuffer"))
                        .then(res => {
                        if (res.data)
                            fs.writeFile(path.join(DATA_DIR, `cache/icon/${gameId}.jpg`), res.data, e => {
                                if (e)
                                    console.error(String(e));
                                try {
                                    if (fs.existsSync(path.join(DATA_DIR, `cache/icon/${gameId}.jpg`))) {
                                        iconPath = vscode.Uri.file(path.join(DATA_DIR, `cache/icon/${gameId}.jpg`));
                                        setIcon();
                                    }
                                }
                                catch (e) {
                                    console.error(String(e));
                                }
                            });
                    })
                        .catch(e => {
                        console.error(String(e));
                    });
        }
        catch (e) {
            console.error(String(e));
        }
    loaded(true);
}
/** è®¾ç½® cookie */
async function setCookie(c = "") {
    COOKIE = c;
    return new Promise(async (resolve, reject) => {
        try {
            context.secrets.store("cookie", c);
            resolve();
        }
        catch (e) {
            err("æ— æ³•è®¾ç½® cookie", e);
            reject(e);
        }
    });
}
/** è·å– cookie */
async function getCookie() {
    return new Promise(async (resolve, reject) => {
        try {
            resolve((COOKIE = (await context.secrets.get("cookie")) || ""));
        }
        catch (e) {
            err("æ— æ³•è·å– cookie", e);
            reject(e);
        }
    });
}
/** å³æ—¶è·å– cookie */
function getCookieSync() {
    if (typeof COOKIE === "undefined") {
        getCookie();
        return "";
    }
    return COOKIE;
}
/**
 * ç™»å½•ç›¸å…³, å¦‚æœªç™»å½•åˆ™è¦æ±‚ç”¨æˆ·ç™»å½•, ç„¶åæ‰§è¡Œå›è°ƒ, å¦åˆ™ç›´æ¥æ‰§è¡Œå›è°ƒ
 * @param callback å›è°ƒ, å‚æ•°ä¸º cookie
 * @param loginOnly ç›´æ¥å±•ç¤ºç™»å½•æ¡†, ä¸åœ¨å³ä¸‹è§’æ˜¾ç¤ºæç¤º
 */
function login(callback, loginOnly = false) {
    loaded(true);
    let c = getCookieSync();
    if (c) {
        if (loginOnly)
            return vscode.window
                .showInformationMessage("æ˜¯å¦é€€å‡ºç™»å½•?", "æ˜¯", "å¦")
                .then(async (value) => {
                if (value === "æ˜¯") {
                    await setCookie();
                    vscode.window.showInformationMessage("é€€å‡ºç™»å½•æˆåŠŸ");
                }
            });
        return callback(getCookieSync());
    }
    else {
        if (!loginOnly)
            vscode.window.showInformationMessage("è¯·ç™»å½•åç»§ç»­");
        vscode.window
            .showQuickPick(["ğŸ†” ä½¿ç”¨è´¦å·å¯†ç ç™»å½•", "ğŸª ä½¿ç”¨ cookie ç™»å½•"])
            .then(value => {
            if (value?.includes("ä½¿ç”¨ cookie ç™»å½•"))
                vscode.window
                    .showInputBox({
                    title: "4399 on VSCode: ç™»å½•(ä½¿ç”¨ cookie)",
                    prompt: "è¯·è¾“å…¥ cookie, è·å–æ–¹æ³•è¯·è§æ‰©å±•è¯¦æƒ…é¡µ, ç™»å½•å, æ‚¨å¯ä»¥ç©é¡µæ¸¸æˆ–è€…ä½¿ç”¨å…¶å®ƒéœ€è¦ç™»å½•çš„åŠŸèƒ½",
                })
                    .then(async (c) => {
                    if (c)
                        try {
                            let parsedCookie = cookie.parse(c);
                            if (!parsedCookie["Pauth"])
                                return err("ç™»å½•å¤±è´¥, cookie æ²¡æœ‰ Pauth å€¼");
                            c = encodeURI(c);
                            await setCookie(c);
                            let welcomeMsg = "";
                            if (parsedCookie["Pnick"])
                                welcomeMsg = `äº²çˆ±çš„ ${parsedCookie["Pnick"]}, æ‚¨å·²`;
                            vscode.window.showInformationMessage(welcomeMsg +
                                "ç™»å½•æˆåŠŸ, è¯·æ³¨æ„å®šæœŸæ›´æ–° cookie");
                            callback(c);
                        }
                        catch (e) {
                            return err("ç™»å½•å¤±è´¥, å…¶å®ƒåŸå› ", String(e));
                        }
                });
            else if (value?.includes("ä½¿ç”¨è´¦å·å¯†ç ç™»å½•"))
                vscode.window
                    .showInputBox({
                    title: "4399 on VSCode: ç™»å½•(ä½¿ç”¨è´¦å·å¯†ç )",
                    prompt: "è¯·è¾“å…¥ 4399 è´¦å·",
                })
                    .then(user => {
                    if (user)
                        vscode.window
                            .showInputBox({
                            title: "4399 on VSCode: ç™»å½•(ä½¿ç”¨è´¦å·å¯†ç )",
                            prompt: "è¯·è¾“å…¥å¯†ç ",
                            password: true,
                        })
                            .then(async (pwd) => {
                            if (pwd)
                                try {
                                    const r = await axios_1.default.post("https://ptlogin.4399.com/ptlogin/login.do?v=1", `username=${user}&password=${pwd}`, getReqCfg("arraybuffer", true));
                                    const html = iconv.decode(r.data, "utf8");
                                    const $ = cheerio.load(html);
                                    const msg = $("#Msg");
                                    if (msg.text())
                                        return err("ç™»å½•å¤±è´¥, ", msg
                                            .text()
                                            .replace(/[\n\r\t ]/gi, ""));
                                    let c = r.headers["set-cookie"];
                                    let cookies = [];
                                    // åˆå¹¶å¤šä¸ª set-cookie
                                    if (c && c[0]) {
                                        c.forEach(co => {
                                            cookies.push(cookie.parse(co));
                                        });
                                        cookies = Object.assign({}, ...cookies, {
                                            Path: "/",
                                            Domain: "4399.com",
                                        });
                                        cookies =
                                            objectToQuery(cookies);
                                        let parsedCookie = cookie.parse(cookies);
                                        if (!parsedCookie["Pauth"])
                                            return err("ç™»å½•å¤±è´¥, cookie æ²¡æœ‰ Pauth å€¼");
                                        cookies =
                                            encodeURI(cookies);
                                        await setCookie(cookies);
                                        let welcomeMsg = "";
                                        if (parsedCookie["Pnick"])
                                            welcomeMsg = `äº²çˆ±çš„ ${parsedCookie["Pnick"]}, æ‚¨å·²`;
                                        vscode.window.showInformationMessage(welcomeMsg +
                                            "ç™»å½•æˆåŠŸ, è¯·æ³¨æ„å®šæœŸé‡æ–°ç™»å½•");
                                        callback(cookies);
                                    }
                                    else
                                        return err("ç™»å½•å¤±è´¥, å“åº”å¤´æ²¡æœ‰ set-cookie");
                                }
                                catch (e) {
                                    return err("ç™»å½•å¤±è´¥, å…¶å®ƒåŸå› ", String(e));
                                }
                        });
                });
        });
    }
}
/** æ›´æ–°å†å²è®°å½• */
function updateHistory(history) {
    if (!getCfg("updateHistory", true))
        return;
    let h = globalStorage(context).get("history");
    if (!h || (typeof h === "object" && !h[0]))
        h = [];
    h.unshift(history);
    globalStorage(context).set("history", h);
}
/** å¯¹è±¡è½¬ query(Ctrl + C and Ctrl + V from CSDN) */
function objectToQuery(obj, prefix) {
    if (typeof obj !== "object")
        return "";
    const attrs = Object.keys(obj);
    return attrs.reduce((query, attr, index) => {
        // åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€å±‚ç¬¬ä¸€ä¸ªå¾ªç¯
        if (index === 0 && !prefix)
            query += "";
        if (typeof obj[attr] === "object") {
            const subPrefix = prefix ? `${prefix}[${attr}]` : attr;
            query += objectToQuery(obj[attr], subPrefix);
        }
        else if (prefix)
            query += `${prefix}[${attr}]=${obj[attr]}`;
        else
            query += `${attr}=${obj[attr]}`;
        // åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€å±‚æœ€åä¸€ä¸ªå¾ªç¯
        if (index !== attrs.length - 1)
            query += ";";
        return query;
    }, "");
}
/** æ¸¸æˆè¯¦æƒ…é¡µé“¾æ¥è½¬æ¸¸æˆ ID */
function parseId(url) {
    if (!isNaN(Number(url)))
        return url;
    let u = new URL(url, "https://www.4399.com/");
    let id = u.searchParams.get("gameId") ||
        path.parse(u.pathname).name.split(/[\_\-\.\/]/g)[0];
    log(url, " -> ", id);
    return Number(id);
}
/** ç­¾åˆ° */
function checkIn(quiet) {
    login(async () => {
        try {
            let data = (await axios_1.default.get("https://my.4399.com/plugins/sign/set-t-" +
                new Date().getTime(), getReqCfg("json"))).data;
            if (data.result === null)
                err("ç­¾åˆ°å¤±è´¥, å…¶ä»–é”™è¯¯: " + data.msg);
            else if (typeof data.result === "string")
                !quiet && vscode.window.showInformationMessage(data.result);
            else if (typeof data.result === "object")
                !quiet &&
                    vscode.window.showInformationMessage(`ç­¾åˆ°æˆåŠŸ, æ‚¨å·²è¿ç»­ç­¾åˆ°${data.result.days}å¤©`);
            else
                err("ç­¾åˆ°å¤±è´¥, è¿”å›æ•°æ®éæ³•");
        }
        catch (e) {
            err("ç­¾åˆ°å¤±è´¥: ", String(e));
        }
    });
}
function is4399Domain(hostname) {
    return hostname === "4399.com" || hostname.endsWith(".4399.com");
}
/** å…¥å£ */
async function activate(ctx) {
    // è¯•è¯•æ‰‹æ°”(æœ‰å‡ ç‡å¤±è´¥)
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.random", () => {
        getPlayUrl("https://www.4399.com/flash/" +
            String(Math.floor(Math.random() * 10000) + 200000) +
            ".htm");
    }));
    // è¾“å…¥æ¸¸æˆ ID (é“¾æ¥ä»¥ http(s)://www.4399.com/flash/ å¼€å¤´)
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.get", () => {
        let i = globalStorage(ctx).get("id1");
        vscode.window
            .showInputBox({
            value: i ? String(i) : "222735",
            title: "4399 on VSCode: è¾“å…¥æ¸¸æˆ ID",
            prompt: "è¾“å…¥æ¸¸æˆé“¾æ¥æˆ– http(s)://www.4399.com/flash/ åé¢çš„æ•°å­—(æ¸¸æˆ ID)",
        })
            .then(id => {
            if (id) {
                log("ç”¨æˆ·è¾“å…¥ ", id);
                globalStorage(ctx).set("id1", id);
                getPlayUrl("https://www.4399.com/flash/" + parseId(id) + ".htm");
            }
        });
    }));
    // è¾“å…¥æ¸¸æˆ ID (é“¾æ¥ä»¥ http(s)://www.zxwyouxi.com/g/ å¼€å¤´)
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.get-h5-web-game", () => {
        let i = globalStorage(ctx).get("id2");
        vscode.window
            .showInputBox({
            value: i ? String(i) : "100060323",
            title: "4399 on VSCode: è¾“å…¥æ¸¸æˆ ID",
            prompt: "è¾“å…¥æ¸¸æˆé“¾æ¥æˆ– http(s)://www.zxwyouxi.com/g/ åé¢çš„æ•°å­—(æ¸¸æˆ ID)",
        })
            .then(id => {
            if (id) {
                log("ç”¨æˆ·è¾“å…¥ ", id);
                globalStorage(ctx).set("id2", id);
                getPlayUrlForWebGames("https://www.zxwyouxi.com/g/" + parseId(id));
            }
        });
    }));
    // æ¨è
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.recommended", () => {
        axios_1.default
            .get("https://www.4399.com/", getReqCfg("arraybuffer"))
            .then(res => {
            if (res.data) {
                res.data = iconv.decode(res.data, "gb2312");
                log("æˆåŠŸè·å–åˆ°4399é¦–é¡µ");
                const $ = cheerio.load(res.data);
                let gameNames = [], urls = [];
                $("#skinbody > div.middle_3.cf > div.box_c > div.tm_fun.h_3 > ul > li > a[href*='/flash/']").each((i, elem) => {
                    urls[i] = $(elem).attr("href");
                });
                $("#skinbody > div.middle_3.cf > div.box_c > div.tm_fun.h_3 > ul > li > a[href*='/flash/'] > img").each((i, elem) => {
                    gameNames[i] = $(elem).attr("alt");
                });
                if (!gameNames[0] || !urls[0])
                    return err("ä¸€ä¸ªæ¨èçš„æ¸¸æˆä¹Ÿæ²¡æœ‰");
                vscode.window
                    .showQuickPick(gameNames)
                    .then(val => {
                    log("ç”¨æˆ·è¾“å…¥:", val);
                    if (!val)
                        return;
                    let index = gameNames.indexOf(val);
                    log("æ¸¸æˆé¡µé¢: ", urls[index]);
                    if (index !== -1) {
                        let url = urls[index];
                        if (!url)
                            return err("å˜é‡ url å¯èƒ½ä¸º undefined");
                        getPlayUrl(url);
                    }
                    else
                        log("ç”¨æˆ·ä¼¼ä¹å–æ¶ˆäº†æ“ä½œ");
                });
            }
        })
            .catch(e => {
            err("æ— æ³•è·å–4399é¦–é¡µ: ", e);
        });
    }));
    // æœç´¢
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.search", () => {
        let s = globalStorage(ctx).get("kwd"); // ä¸Šæ¬¡æœç´¢è¯
        searchGames(s);
    }));
    // æˆ‘çš„
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.my", () => {
        login(c => {
            let Pnick = cookie.parse(c)["Pnick"] || "æœªçŸ¥";
            Pnick = Pnick === "0" ? "æœªçŸ¥" : Pnick;
            vscode.window
                .showQuickPick([
                "ğŸ†” æ˜µç§°: " + Pnick,
                "â¤ï¸ æˆ‘çš„æ”¶è—ç›’",
                "âœ¨ çŒœä½ å–œæ¬¢",
                "ğŸ•’ æˆ‘ç©è¿‡çš„",
                "ğŸ–Š ç­¾åˆ°",
                "ğŸšª é€€å‡ºç™»å½•",
            ])
                .then(async (value) => {
                if (value) {
                    const getGames = async (url, index = "recommends") => {
                        try {
                            let favorites = (await axios_1.default.get(url, getReqCfg("json"))).data;
                            let _favorites = {};
                            let names = [];
                            if (favorites &&
                                favorites.game_infos &&
                                favorites[index]) {
                                let info = favorites.game_infos;
                                favorites[index].forEach(o => {
                                    let id = typeof o === "number"
                                        ? o
                                        : o.gid;
                                    _favorites[info[id].name] =
                                        info[id].c_url;
                                    names.push(info[id].name);
                                });
                                vscode.window
                                    .showQuickPick(names)
                                    .then(game => {
                                    if (game)
                                        getPlayUrl(_favorites[game]);
                                });
                            }
                        }
                        catch (e) {
                            err("è·å–å¤±è´¥", String(e));
                        }
                    };
                    if (value.includes("æˆ‘çš„æ”¶è—"))
                        getGames("https://gprp.4399.com/cg/collections.php?page_size=999", "games");
                    else if (value.includes("çŒœä½ å–œæ¬¢"))
                        getGames("https://gprp.4399.com/cg/recommend_by_both.php?page_size=100", "recommends");
                    else if (value.includes("æˆ‘ç©è¿‡çš„"))
                        getGames("https://gprp.4399.com/cg/get_gamehistory.php?page_size=100", "played_gids");
                    else if (value.includes("ç­¾åˆ°"))
                        checkIn();
                    else if (value.includes("é€€å‡ºç™»å½•"))
                        login(() => { }, true);
                }
            });
        });
    }));
    // æ¸¸æˆè¯¦æƒ…
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.detail", async () => {
        showGameInfo();
    }));
    // å†å²è®°å½•
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.history", () => {
        try {
            let h = globalStorage(ctx).get("history");
            if (!h || (typeof h === "object" && !h[0]))
                h = [];
            h.unshift({
                webGame: false,
                name: "ğŸ§¹ æ¸…ç©ºå†å²è®°å½•",
                url: "",
                date: "",
            });
            let quickPickList = [];
            h.forEach(obj => {
                quickPickList.push(obj.name + obj.date);
            });
            vscode.window.showQuickPick(quickPickList).then(gameName => {
                if (gameName === "ğŸ§¹ æ¸…ç©ºå†å²è®°å½•")
                    return globalStorage(ctx).set("history", []);
                if (gameName)
                    for (let index = 0; index < h.length; index++) {
                        const item = h[index];
                        if (item.name + item.date === gameName) {
                            if (item.webGame)
                                getPlayUrlForWebGames(item.url);
                            else
                                getPlayUrl(item.url);
                            break;
                        }
                    }
            });
        }
        catch (e) {
            err("æ— æ³•è¯»å–å†å²è®°å½•", String(e));
        }
    }));
    // é€›ç¾¤ç»„
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.forums", () => {
        login(async () => {
            try {
                if (threadQp)
                    threadQp.show();
                // let threadData: [string, number][];
                // let threadQpItems: vscode.QuickPickItem[] = [];
                // let forums: Record<string, number> = {};
                // let threadTimeout: NodeJS.Timeout;
                // let threadPage = 1;
                let k = globalStorage(ctx).get("kwd-forums"); // ä¸Šæ¬¡æœç´¢è¯
                threadQp = await createQuickPick({
                    value: k || "",
                    title: "4399 on VSCode: é€›ç¾¤ç»„",
                    prompt: "æœç´¢ç¾¤ç»„",
                });
                const getThreads = async (id, title) => {
                    threads = {};
                    threadData = [];
                    threadQpItems = [];
                    threadQp.busy = true;
                    log("å¸–å­ ID: " + id);
                    let d = (await axios_1.default.get(`https://my.4399.com/forums/mtag-${id}`, getReqCfg("arraybuffer"))).data;
                    if (d) {
                        const $ = cheerio.load(d);
                        threads = {};
                        threadData = [];
                        // è·å–æ ‡é¢˜å’Œç±»å‹
                        $("div.listtitle > div.title").each((i, elem) => {
                            let $title = $(elem).children("a.thread_link");
                            let id = Number($title.attr("href")?.split("-").at(-1));
                            let gid = $("div.toplink > a[href*='']");
                            let title = $title.text();
                            let type = $(elem).children("a.type").text();
                            if (!id || isNaN(id) || !title)
                                return;
                            type = type || "[é¡¶] ";
                            title = type + title;
                            threadData.push([title, id]);
                            threads[title] = id;
                        });
                        threadData.forEach(g => {
                            threadQpItems.push({
                                label: g[0],
                                description: "è¿›å…¥å¸–å­",
                                alwaysShow: true,
                            });
                            threads[g[0]] = g[1];
                        });
                        threadQpItems.push({
                            label: "åˆ°åº•äº†",
                            description: "åªå±•ç¤ºç¬¬ä¸€é¡µå†…å®¹",
                            alwaysShow: true,
                        });
                        if (threadQpItems[0]) {
                            threadQp.items = threadQpItems;
                            threadQp.title = "ç¾¤ç»„: " + title;
                        }
                        threadQp.busy = false;
                    }
                    else
                        err("æ— æ³•è·å–ç¾¤ç»„é¡µé¢");
                };
                const search = (kwd) => {
                    clearTimeout(threadTimeout);
                    log("é¡µç : " + threadPage);
                    threadTimeout = setTimeout(() => {
                        threadQp.busy = true;
                        axios_1.default
                            .get("https://my.4399.com/forums/index-getMtags?type=game&keyword=" +
                            encodeURI(kwd || "") +
                            "&page=" +
                            threadPage, getReqCfg("arraybuffer"))
                            .then(res => {
                            if (!res.data)
                                return err("è·å–æœç´¢å»ºè®®å¤±è´¥");
                            res.data = iconv.decode(res.data, "utf8");
                            let d = res.data;
                            const $ = cheerio.load(d);
                            threads = {};
                            threadData = [];
                            threadQpItems = [];
                            $("ul > li > a > span.title").each((i, elem) => {
                                let g = $(elem).text();
                                let id = $(elem)
                                    .parent()
                                    .attr("href")
                                    ?.split("-")
                                    ?.at(-1);
                                if (!id || isNaN(Number(id)))
                                    return;
                                id = Number(id);
                                threadData.push([g, id]);
                                threads[g] = id;
                            });
                            threadData.forEach(g => {
                                threadQpItems.push({
                                    label: g[0],
                                    description: "ç¾¤ç»„ ID: " + g[1],
                                    alwaysShow: true,
                                });
                                threads[g[0]] = g[1];
                            });
                            threadQpItems.push({
                                label: "ä¸‹ä¸€é¡µ",
                                description: "åŠ è½½ä¸‹ä¸€é¡µå†…å®¹",
                                alwaysShow: true,
                            });
                            if (threadQpItems[0])
                                threadQp.items = threadQpItems;
                            threadQp.busy = false;
                        })
                            .catch(e => {
                            return err("è·å–æœç´¢å»ºè®®å¤±è´¥", String(e));
                        });
                    }, 1000);
                };
                threadQp.onDidChangeValue(kwd => {
                    if (kwd === threadSearchValue)
                        return (threadQp.items = threadQpItems);
                    threadQp.title = "4399 on VSCode: é€›ç¾¤ç»„";
                    threadSearchValue = kwd;
                    threadPage = 1;
                    search(kwd);
                });
                threadQp.onDidAccept(async () => {
                    if (threadQp.activeItems[0].label === "ä¸‹ä¸€é¡µ") {
                        threadPage++;
                        search(threadQp.value);
                    }
                    else if (threadQp.activeItems[0].description?.includes("ç¾¤ç»„ ID")) {
                        getThreads(threads[threadQp.activeItems[0].label], threadQp.activeItems[0].label);
                        globalStorage(context).set("kwd-forums", threadQp.value);
                    }
                    else if (threadQp.activeItems[0].description === "è¿›å…¥å¸–å­")
                        try {
                            if (threadQp.activeItems[0].label) {
                                threadQp.hide();
                                let id = threads[threadQp.activeItems[0].label];
                                let fullWebServerUri = await vscode.env.asExternalUri(vscode.Uri.parse("http://localhost:" + PORT));
                                let d = (await axios_1.default.get(`https://my.4399.com/forums/thread-${id}`, getReqCfg("arraybuffer"))).data;
                                if (d) {
                                    const $ = cheerio.load(d);
                                    let title = $("div.host_main_title > a").text();
                                    if (!title)
                                        err("æ— æ³•è·å–å¸–å­é¡µé¢: æ ‡é¢˜ä¸ºç©º");
                                    // é¢„å¤„ç†
                                    // ä¿®æ”¹ // ä¸º https://
                                    $("img").each((i, elem) => {
                                        let s = $(elem).attr("src");
                                        if (s) {
                                            s = s.replaceAll(/ |\n|\%20|\%0A/g, "");
                                            if (!s.startsWith("http")) {
                                                s = s.replace("//", "https://");
                                                $(elem).attr("src", s);
                                            }
                                        }
                                    });
                                    // è§£é™¤é˜²ç›—é“¾é™åˆ¶
                                    $("img").each((i, elem) => {
                                        let u = new URL("/_4ov/proxy/" +
                                            $(elem)
                                                .attr("src")
                                                ?.replaceAll(/ |\n|\%20|\%0A/g, ""), String(fullWebServerUri));
                                        $(elem).attr("src", String(u));
                                    });
                                    $("#send-floor,[class*='user_actions'],script,style,link,meta,object").remove();
                                    // ä»å¸–
                                    let singlePostHtml = "";
                                    $(".single_post").each((i, elem) => {
                                        if (i === 0)
                                            return;
                                        singlePostHtml +=
                                            " <hr/> " +
                                                ($("[class*='post_author_name']", elem).html() || "") + // å¼ ä¸‰
                                                " " +
                                                ($(".post_title", elem).html() || "") + // å‘è¡¨äº 2022-12-31 23:59:59 ç¦å»º ä¿®æ”¹äº 2022-12-31 23:59:59 æ²™å‘
                                                " <br/> " +
                                                ($(".main_content", elem).html() || "") + // æ­£æ–‡
                                                " <br /> ";
                                    });
                                    // ç”Ÿæˆæ–‡ç«  html
                                    let html = 
                                    // ä¸»å¸–
                                    " <br /> <h1>" +
                                        ($(".mainPost .host_main_title a").html() || "") + // (btd) éœ‡æƒŠ, 3 + 3 å±…ç„¶ç­‰äº 3!
                                        "</h1> <br /> " +
                                        `
                                               <style>* {color: #888;}</style>
                                               <a href="https://my.4399.com/forums/thread-${id}">åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€</a>
                                            ` +
                                        ($(".mainPost [class*='post_author_name']").html() || "") + // å¼ ä¸‰
                                        " " +
                                        ($(".mainPost .host_title").html() || "") + // æ¥¼ä¸» å‘è¡¨äº 2022-12-31 23:59:59 ç¦å»º ä¿®æ”¹äº 2022-12-31 23:59:59
                                        " <br /> " +
                                        ($(".mainPost .host_content").html() || "") + // æ­£æ–‡
                                        " <br /> " +
                                        singlePostHtml;
                                    html = html
                                        .replaceAll(/(#ffffff|#fff)/gi, "transparent")
                                        .replaceAll(/(javascript|on.+=)/gi, "ovo");
                                    initHttpServer(() => {
                                        panel =
                                            vscode.window.createWebviewPanel("4399OnVscode", title || "4399 on VSCode", vscode.ViewColumn.Active, {
                                                enableScripts: false,
                                                localResourceRoots: [],
                                            });
                                        panel.webview.html = html;
                                    }, "http://my.4399.com/");
                                }
                                else
                                    err("æ— æ³•è·å–å¸–å­é¡µé¢");
                            }
                        }
                        catch (e) {
                            err("æ— æ³•è·å–å¸–å­é¡µé¢", String(e));
                        }
                });
                threadQp.show();
                if (!threadSearchValue)
                    search(k || "");
            }
            catch (e) {
                err("æ— æ³•è·å–ç¾¤ç»„é¡µé¢", String(e));
            }
        });
    }));
    // æ›´å¤šæ“ä½œ
    ctx.subscriptions.push(vscode.commands.registerCommand("4399-on-vscode.more-action", () => {
        vscode.window
            .showQuickPick([
            "å®‰è£… HTML ä»£ç ç‰‡æ®µ",
            "âš ï¸ ä»¥ä¸‹é€‰é¡¹ä»…åº”ç”¨äºå¼€å‘ç”¨é€” â¬‡ï¸",
            "å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨",
            "å…³é—­æœ¬åœ°æœåŠ¡å™¨",
            "å¯åŠ¨ç®€æ˜“æµè§ˆå™¨",
        ])
            .then(async (val) => {
            if (val === "å®‰è£… HTML ä»£ç ç‰‡æ®µ")
                openUrl("https://dsy4567.github.io/4ov-scripts/");
            else if (val === "å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨")
                initHttpServer(async () => {
                    server =
                        (await vscode.window.showInputBox({
                            title: "è¯·è¾“å…¥è¢«ä»£ç†çš„æœåŠ¡å™¨åŸŸå",
                            value: "szhong.4399.com",
                        })) || "szhong.4399.com";
                    gamePath =
                        (await vscode.window.showInputBox({
                            title: "è¯·è¾“å…¥æ¸¸æˆå…¥å£è·¯å¾„(å¯é€‰)",
                            placeHolder: "/foo/bar",
                        })) || "/_4ov/proxy/https://www.4399.com/";
                    let u = new URL(gamePath, "http://" + server);
                    if (u.pathname === "/")
                        u.pathname =
                            "/_4ov/proxy/https://www.4399.com/";
                    gameUrl = u.toString();
                    try {
                        DATA = (await axios_1.default.get(gameUrl, getReqCfg("arraybuffer"))).data;
                    }
                    catch (e) {
                        DATA = "";
                    }
                }, await vscode.window.showInputBox({
                    title: "è¯·è¾“å…¥ referer (å¯é€‰)",
                    placeHolder: "https://www.4399.com/",
                }));
            else if (val === "å…³é—­æœ¬åœ°æœåŠ¡å™¨")
                try {
                    await axios_1.default.get("http://127.0.0.1:" +
                        PORT +
                        "/_4ov/stop/" +
                        globalStorage(context).get("stop-secret"));
                }
                catch (e) { }
            else if (val === "å¯åŠ¨ç®€æ˜“æµè§ˆå™¨")
                showWebviewPanel((await vscode.window.showInputBox({
                    title: "è¯·è¾“å…¥ç½‘å€",
                    value: "https://www.4399.com/",
                })) || "https://www.4399.com/", "ç®€æ˜“æµè§ˆå™¨");
        });
    }));
    context = ctx;
    // åˆå§‹åŒ–æ•°æ®ç›®å½•
    fs.mkdir(path.join(DATA_DIR, "cache/icon"), { recursive: true }, err => {
        err && console.error(err);
    });
    fs.mkdir(path.join(DATA_DIR, "html-scripts"), { recursive: true }, err => {
        err && console.error(err);
    });
    if (!fs.existsSync(path.join(DATA_DIR, "html-scripts/example.html")))
        fs.writeFile(path.join(DATA_DIR, "html-scripts/example.html"), `\
<!-- ç”± 4399 on VSCode åˆ›å»ºçš„ç¤ºä¾‹ HTML ä»£ç ç‰‡æ®µ -->
<!-- å»è¿™é‡Œçœ‹çœ‹å§ https://dsy4567.github.io/4ov-scripts/ -->
`, err => {
            err && console.error(err);
        });
    let stopSecret = Math.random();
    globalStorage(ctx).set("stop-secret", "" + stopSecret);
    log("stop-secret:", stopSecret);
    axios_1.default.interceptors.request.use(function (config) {
        let u = new URL(config.url || "https://www.example.com");
        if (!isLocalhost(u.hostname))
            u.protocol = "https:"; // å¼ºåˆ¶ https
        // åŸŸåæ£€æµ‹
        if (!is4399Domain(u.hostname))
            config.headers && (config.headers["cookie"] = "");
        config.url && (config.url = "" + u);
        config.headers && (config.headers["host"] = u.hostname);
        return config;
    }, function (error) {
        return Promise.reject(error);
    });
    // åˆå§‹åŒ–cookie, å·²ç™»å½•åˆ™æ£€æŸ¥ç™»å½•çŠ¶æ€
    (await getCookie()) &&
        axios_1.default
            .get("https://u.4399.com/profile/index.html", getReqCfg("arraybuffer"))
            .then(async (res) => {
            const $ = cheerio.load(await iconv.decode(res.data, "utf8"));
            if (!$("#loginUserNick")[0])
                vscode.window
                    .showErrorMessage("ç™»å½•å¤±è´¥", "é€€å‡ºç™»å½•")
                    .then(val => {
                    if (val === "é€€å‡ºç™»å½•")
                        setCookie();
                });
            else if (getCfg("automaticCheckIn"))
                checkIn(true);
        })
            .catch(e => err("è·å–ç™»å½•çŠ¶æ€å¤±è´¥:", e));
    console.log("4399 on VSCode is ready!");
}
exports.activate = activate;
//# sourceMappingURL=extension.js.map